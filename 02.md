# 数据组件模块化拆分完整日志

## 改造目标
- 实现状态管理与数据模块的协同拆分，保持整体架构一致性（UI层 → 状态管理 → 数据管理）
- 对外API完全兼容：`useCardStore` 与 `DataManager` 接口保持不变，调用方无感知
- 严格区分状态管理与数据处理职责边界，状态管理专注于功能性状态维护，数据模块专注于数据存储与业务逻辑
- 保持所有样式、交互、功能、逻辑、时序及持久化行为不变，仅优化代码组织结构与可维护性

## 改造摘要
- 采用"分层模块化"架构，将原有集中式的 `store.js` 与 `manager.js` 拆分为职责单一的子模块
- 保留 `store.js` 与 `manager.js` 作为门面/代理层，确保对外接口兼容
- 新增多级目录结构，按功能域清晰划分模块职责，形成可扩展的模块化体系
- 保持Pinia单例语义与数据持久化机制不变，所有状态与数据操作的时序逻辑与原实现一致
- 实现状态管理与数据模块的协同工作，明确模块间依赖关系，避免循环依赖

## 目录结构（拆分后）
```
src/components/Data/
├─ store.js                          # 状态管理入口：聚合state/getters，actions委托至store-parts/state
├─ manager.js                        # 数据管理入口：核心实现+代理转发至各数据模块
├─ api.js                            # 数据接口（未改）
├─ store-parts/
│  ├─ state/                         # 状态管理子模块
│  │  ├─ routing.js                  # 动态路由与模式页面注册/删除/导航/路由记录
│  │  ├─ linkage.js                  # 模式联动：权限校验、字段同步判定、跨模式同步主流程
│  │  ├─ envConfigs.js               # 环境配置标准字段：加载/规范化/保存/上下游通知
│  │  ├─ questions.js                # 题库加载、校验、增删
│  │  ├─ rootMode.js                 # 主模式root_admin的标准/草稿操作与Excel样式ID支持
│  │  ├─ presets.js                  # 卡片预设映射的加载/保存/应用
│  │  ├─ cards.js                    # 会话/临时卡片、选项、下拉、编辑态、中期存储、导入导出
│  │  ├─ subModes.js                 # 子模式实例加载与解析（授权位映射）
│  │  ├─ feedback.js                 # 匹配提交与反馈生成/持久化
│  │  ├─ dataSection.js              # 数据段管理区（列表、筛选、删除、预览导入/应用）
│  │  ├─ modes.js                    # 模式的添加/删除/查询/持久化（含路由联动）
│  │  ├─ init.js                     # 全量初始化编排（按原时序）
│  │  └─ modeLocalEdit.js            # 模式内本地编辑（授权位限流 + 环境配置联动）
│  └─ data/                          # 数据管理子模块
│     ├─ normalize.js                # 数据归一化工具
│     ├─ cards.js                    # 卡片模板与规范化
│     ├─ modes.js                    # 模式/主模式配置（可删除项已注释标记）
│     ├─ subModes.js                 # 子模式（合并版：兼容A/B）
│     ├─ envConfigs.js               # 环境配置（合并版：兼容A/B + 快照辅助）
│     ├─ feedback.js                 # 匹配/评分/保存反馈（合并版：兼容A/B）
│     ├─ sync/
│     │  ├─ history.js               # 同步历史（可选：旧键兼容）
│     │  ├─ authorization.js         # 字段授权
│     │  ├─ status.js                # 同步状态查询/更新
│     │  └─ index.js                 # 聚合导出
│     └─ linkage/
│        ├─ rules.js                 # 规则CRUD + 轻量校验
│        ├─ transforms.js            # 字段转换注册/应用
│        ├─ executor.js              # 执行正向/反向联动 + 历史记录
│        └─ index.js                 # 聚合导出
├─ storage/
│  └─ LocalStorageStrategy.js        # 本地存储策略（统一前缀）
├─ services/
│  ├─ longTerm.js                    # 长期存储CRUD + 复合键命名
│  ├─ id.js                          # ID生成/校验（卡片ID、选项ID）
│  └─ io.js                          # 导入/导出（DOM下载保留，后续可上移到UI）
├─ validators/
│  └─ dataValidator.js               # [可能需要删除] 通用数据校验
├─ utils/
│  ├─ objectPath.js                  # get/set嵌套字段
│  └─ uiTooltip.js                   # [可能需要删除] UI提示文本
└─ Othermodes
   └─ OtherModeTemplate.vue          # 动态路由使用（未改）
```

## 拆分依据与原则
1. **职责单一化**：
   - 状态管理模块专注于UI状态维护、交互逻辑与状态流转
   - 数据模块专注于数据存储、校验、转换与业务规则实现
   - 服务层提供通用能力（存储、ID生成、导入导出）
   - 工具层提供跨模块通用工具函数

2. **依赖方向明确**：
   - 上层模块（状态管理）可调用下层模块（数据管理、服务、工具）
   - 下层模块不依赖上层模块，避免循环依赖
   - 同层模块间通过明确接口交互，减少直接耦合

3. **兼容性保障**：
   - 保留原有入口文件作为门面，确保对外接口不变
   - 所有持久化键名与结构保持兼容，不丢失历史数据
   - 支持新旧调用方式并存，便于渐进式迁移

4. **可维护性提升**：
   - 按功能域划分模块，边界清晰，便于定位与修改
   - 模块内部高内聚，模块之间低耦合
   - 保留核心业务逻辑的时序与行为不变

## 各模块职责说明

### 状态管理层（store-parts/state）
- **routing.js**：管理动态路由实例、模式页面创建与导航，基于OtherModeTemplate.vue创建组件
- **linkage.js**：处理模式联动逻辑，包括权限校验、字段同步判定与跨模式同步流程
- **envConfigs.js**：管理环境配置的加载、规范化、保存与变更通知
- **questions.js**：负责题库的加载、校验与增删操作
- **rootMode.js**：处理主模式root_admin的相关操作，包括标准保存、草稿管理与Excel样式ID支持
- **presets.js**：管理卡片预设映射的加载、保存与应用
- **cards.js**：处理卡片相关状态，包括会话/临时卡片管理、编辑状态切换与导入导出
- **subModes.js**：管理子模式实例的加载与解析，处理授权位映射
- **feedback.js**：处理匹配提交、反馈生成与持久化
- **dataSection.js**：管理数据段列表、筛选、删除与导入导出操作
- **modes.js**：处理模式的添加、删除、查询与持久化，联动路由管理
- **init.js**：编排全量初始化流程，保持原有时序
- **modeLocalEdit.js**：处理模式内本地编辑，受授权位限制并联动环境配置

### 数据管理层（store-parts/data）
- **normalize.js**：提供数据归一化工具函数，确保数据结构一致性
- **cards.js**：定义卡片模板与规范化规则
- **modes.js**：管理模式与主模式配置数据
- **subModes.js**：处理子模式数据的加载、保存与解析，兼容新旧版本
- **envConfigs.js**：管理环境配置数据，提供加载、保存与快照功能
- **feedback.js**：处理匹配、评分与反馈数据的管理
- **sync/**：管理同步相关数据，包括历史记录、授权与状态
- **linkage/**：处理联动规则、字段转换与执行逻辑

### 存储与服务层
- **storage/LocalStorageStrategy.js**：提供统一的本地存储策略，处理前缀与JSON序列化
- **services/longTerm.js**：提供长期存储的CRUD操作，支持复合键命名
- **services/id.js**：负责卡片ID与选项ID的生成与校验
- **services/io.js**：提供数据导入导出功能，包括文件处理与DOM下载

### 工具与验证层
- **utils/objectPath.js**：提供嵌套字段的get/set操作
- **utils/uiTooltip.js**：生成UI提示文本（计划迁移至UI层）
- **validators/dataValidator.js**：通用数据校验（计划拆分至各子域）

## 兼容措施与迁移策略
1. **接口兼容**：
   - `store.js` 与 `manager.js` 保留原有接口，内部委托至新模块
   - 所有对外常量、类与方法签名保持不变

2. **数据兼容**：
   - 保留所有原有存储键名，如`question_bank`、`environment_configs`等
   - 新增复合键采用独立命名空间，不影响旧数据
   - 提供数据读取的兼容性处理，支持新旧存储方式并存

3. **渐进式迁移**：
   - 现有代码可继续使用旧接口，无需修改
   - 新功能开发可直接使用拆分后的模块
   - 提供明确的可删除/可合并清单，分阶段优化

## 可优化项与后续计划
1. **优先删除项**：
   - `validators/dataValidator.js`：拆分为各子域轻量校验
   - `utils/uiTooltip.js`：迁移至UI层

2. **模块合并**：
   - 同步子系统：`sync/history.js + authorization.js + status.js` 合并为`sync.js`
   - 模式子系统：`modes.js + subModes.js` 合并为`modes/index.js`
   - 规范化/卡片：`normalize.js + cards.js` 合并为统一模块

3. **架构增强**：
   - 明确模块间依赖关系文档
   - 完善各模块单元测试
   - 逐步迁移旧调用至新模块接口

## 关键不变性验证
- 所有状态与数据的持久化行为保持不变
- 业务逻辑与操作时序完全一致
- Excel样式ID生成与比较规则不变
- 联动同步与授权校验规则不变
- 导入导出功能与数据格式兼容

本次模块化拆分旨在提升代码可维护性与扩展性，同时确保现有功能不受影响。通过清晰的职责划分与兼容设计，为后续功能迭代与架构演进奠定基础。