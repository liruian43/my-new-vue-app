# 项目规范文档（完整最终版）

## 目录
1. 前言
2. Excel样式ID规范
3. 卡片数据结构与状态管理规范
4. 多模式数据处理与流转规范
5. 系统核心架构与分层职责
6. 五大模块数据流程（主线）
7. 环境全量区与联动功能合并说明
8. 附录


## 1. 前言
本文档整合项目全量规范，涵盖标识规则、数据结构、流转逻辑、架构设计及模块职责。核心目标是确保系统各环节环节环节遵循统一标准：**数据完整性优先、分层职责清晰、同步授权逻辑明确**，为开发提供唯一权威参考。本次更新明确了题库与环境全量区的"经书上下半部"关系，组合表达式的宽松排序验证规则，以及其他模式数据提交的"所见即所提"原则。


## 2. Excel样式ID规范
### 2.1 基础格式定义
采用“卡片标识+选项标识”的组合格式，用于唯一定位卡片及下属选项：
- **卡片标识**：纯大写英文字母序列（A-Z→AA-AZ→BA-BZ...），示例："A"、"BC"、"XYZ"
- **选项标识**：纯阿拉伯数字（1,2,3...），示例："1"、"5"、"12"
- **完整ID**：卡片标识+选项标识，示例："A1"（A卡片第1个选项）、"BC3"（BC卡片第3个选项）

### 2.2 生成规则
#### 2.2.1 卡片标识生成
- 初始标识为"A"，按字母顺序递增，单字母用尽后自动扩展位数：
  - 单字母：A→B→...→Z（共26个）
  - 双字母：AA→AB→...→AZ→BA→...→BZ（共26×26个）
  - 以此类推（三字母、四字母等）
- 生成函数示例：
  ```javascript
  function generateNextCardId(lastId) {
    let chars = lastId.split('');
    let i = chars.length - 1;
    while (i >= 0 && chars[i] === 'Z') {
      chars[i] = 'A';
      i--;
    }
    if (i < 0) chars.unshift('A');
    else chars[i] = String.fromCharCode(chars[i].charCodeAt(0) + 1);
    return chars.join('');
  }
  ```

#### 2.2.2 选项标识生成
- 每个卡片的首个选项标识为"1"
- 新增选项时，标识为当前卡片已有选项中的**最大标识+1**（与删除无关）：
  - 示例1：现有选项["1","2","3"]→新增为"4"
  - 示例2：现有选项["1","3","5"]→新增为"6"（最大标识为5，5+1=6）
- 生成函数示例：
  ```javascript
  function generateNextOptionId(existingOptions) {
    const maxId = existingOptions.reduce((max, id) => {
      const num = parseInt(id, 10);
      return num > max ? num : max;
    }, 0);
    return (maxId + 1).toString();
  }
  ```

### 2.3 解析规则
- 解析目标：将完整ID拆分为卡片标识和选项标识
- 解析函数示例：
  ```javascript
  function parseCombinedId(combinedId) {
    const match = combinedId.match(/^([A-Z]+)(\d+)$/);
    if (!match) return { isValid: false };
    return {
      combinedId,
      cardId: match[1],
      optionId: match[2],
      isValid: true
    };
  }
  ```
- 无效格式示例："a1"（小写字母）、"1A"（数字在前）、"A-1"（含特殊字符）


## 3. 卡片数据结构与状态管理规范
### 3.1 核心数据结构（五项内容规范）
卡片及选项的基础结构必须包含以下字段，**无论是否有值/是否同步，字段均需存在**：

| 字段标识         | 含义                  | 数据类型                  | 空值标准（数据层） | 说明 |
|------------------|-----------------------|---------------------------|--------------------|------|
| `title`          | 卡片标题              | string \| null            | `null`             | 卡片的整体名称 |
| `optionName`     | 选项名称              | string \| null            | `null`             | 单个选项的名称 |
| `optionValue`    | 选项值                | string \| number \| null  | `null`             | 选项的具体数值或文本 |
| `optionUnit`     | 选项单位              | string \| null            | `null`             | 选项值的单位（如"kg"、"个"） |
| `selectOptions`  | 下拉菜单选项          | string[]                  | `[]`（空数组）     | 预定义的可选值列表 |

### 3.2 同步与授权状态（syncStatus）
同步控制“是否有数据可展示”，授权控制“是否允许编辑”，两者独立且需显式配置：

#### 3.2.1 状态结构
```typescript
interface SyncStatus {
  title: { 
    hasSync: boolean; // 是否同步数据（true=有数据可展示，false=无数据）
    isAuthorized: boolean; // 是否允许编辑（true=可编辑，false=只读）
  };
  options: {
    name: { hasSync: boolean; isAuthorized: boolean };
    value: { hasSync: boolean; isAuthorized: boolean };
    unit: { hasSync: boolean; isAuthorized: boolean };
  };
  selectOptions: { 
    hasSync: true; // 固定为true（结构必须同步）
    isAuthorized: false; // 固定为false（仅主模式可编辑）
  };
}
```

#### 3.2.2 其他模式表现（核心逻辑）
| 场景 | 同步状态（hasSync） | 授权状态（isAuthorized） | 其他模式UI表现 |
|------|---------------------|--------------------------|----------------|
| 1    | false（未同步）     | false（未授权）          | 显示空白，控件禁用（不可编辑） |
| 2    | false（未同步）     | true（已授权）           | 显示空白，控件可交互（允许输入） |
| 3    | true（已同步）      | false（未授权）          | 显示同步的内容，控件禁用（灰色） |
| 4    | true（已同步）      | true（已授权）           | 显示同步的内容（作为提示），控件可交互（允许修改） |

### 3.3 空值处理（分层职责）
空值处理严格遵循分层原则，**禁止UI层参与数据转换**：

| 层级         | 处理逻辑                                                                 | 示例                          |
|--------------|--------------------------------------------------------------------------|-------------------------------|
| **数据层**   | 所有空值必须显式存储为`null`（禁止使用空字符串`""`、`undefined`或缺失字段） | 未填写的标题存储为`title: null` |
| **状态管理** | 负责反向解析：将数据层的`null`转换为UI层可直接使用的空白（`""`）           | 转换函数：`storageToDisplay = (v) => v === null ? "" : String(v)` |
| **UI层**     | 直接使用状态管理传递的已转换数据（空白），不处理任何值转换逻辑              | 输入框绑定状态管理的`displayValue`（空白则显示空输入框） |


## 4. 多模式数据处理与流转规范
### 4.1 核心流转规则（跨模块通用）
- **同步触发**：仅支持主模式手动点击同步按钮（无自动同步）
- **数据过滤**：按`syncStatus.hasSync`筛选字段（未同步字段在目标模式中为`null`）
- **失败处理**：同步失败仅支持手动重试（无自动重试）
- **空值传递**：流转过程中保持`null`不变，由状态管理在各模块内转换为空白（引用3.3节）

### 4.2 临时数据与持久化规则
- **临时数据（_tempData）**：  
  - 定义：用户正在编辑但未确认保存的数据（如未点击“保存”按钮的草稿）  
  - 存储：仅存在于内存，关闭页面或刷新后丢失  
  - 转换：需手动点击“添加到题库”按钮（`persistToLibrary()`）才转为持久化数据  

- **持久化数据（_persistedData）**：  
  - 存储位置：题库及环境全量区  
  - 存储范围：手动添加时，**自动存储全量信息**（包括未勾选同步的字段、未编辑的空值字段）  
  - 关联存储：添加到题库时，自动同步更新环境全量区的关联配置  


## 5. 系统核心架构与分层职责
### 5.1 分层架构
| 层级         | 技术实现          | 核心职责                                                                 | 禁止行为                                                                 |
|--------------|-------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| **UI层**     | Vue组件（.vue）   | 1. 渲染页面元素（按钮、输入框等）<br>2. 接收用户操作并调用状态管理方法<br>3. 展示状态管理提供的已转换数据（空白/同步内容） | 1. 禁止直接访问数据模块<br>2. 不处理任何数据转换（如`null→空白`）<br>3. 不存储数据（所有数据从状态管理获取） |
| **状态管理** | Vue Pinia         | 1. 作为中间层，转发UI层指令到数据模块<br>2. 执行反向解析（含`null→空白`转换）<br>3. 维护响应式状态供UI层使用 | 1. 不存储原始数据（从数据模块获取，不缓存副本）<br>2. 不参与正向解析（不处理UI原始数据的标准化） |
| **数据模块** | JavaScript模块    | 1. 存储全量数据（临时+持久化）<br>2. 执行正向解析（UI原始数据→标准化格式）<br>3. 提供数据操作接口（仅对状态管理开放） | 1. 不处理UI交互逻辑<br>2. 不参与反向解析（不关心UI展示格式）<br>3. 不直接暴露内部数据（返回副本） |

### 5.2 单模块内部数据处理（技术细节）
以“用户在其他模式编辑选项值”为例，描述单个模块内的分层交互：  
1. **用户输入**：UI层接收原始输入（如" 5 "，带空格）→ 调用状态管理`updateOptionValue(rawData)`  
2. **指令转发**：状态管理将原始数据转发给数据模块`updateTempData(rawData)`  
3. **正向解析**：数据模块标准化处理（去空格→"5"，若为空则存`null`）→ 更新临时数据  
4. **反向解析**：状态管理从数据模块获取标准化数据→ 转换为UI格式（"5"或空白）  
5. **UI展示**：UI层从状态管理获取已转换数据，更新输入框显示  


## 6. 五大模块数据流程（主线）
按数据从源头到结尾的顺序描述，明确模块间的衔接关系：

### 6.1 主模式（root_admin）→ 数据源头
- **功能**：  
  1. 按ExcelID规则创建卡片/选项（引用2.2节）  
  2. 配置卡片数据（`title`/`optionValue`等，引用3.1节）  
  3. 设定`syncStatus`（同步/授权规则，引用3.2节）  
  4. 手动触发两个关键操作：  
     - 点击“保存到题库”→ 将组合规则持久化到题库，将原始参数存储到环境全量区  
     - 点击“同步到其他模式”→ 向环境全量区发起同步指令，传递参数标准  

### 6.2 题库 → 规则典籍（上半部经书）  
- **核心定位**：独立存储“组合表达式”及“逻辑规则”，不存储具体参数，也不直接查询环境全量区（如同“只记载‘A1+B2+C3→屠龙刀’的公式，不记载A1/B2/C3具体是什么”）。  
- **功能**：  
  1. 存储完整组合表达式（如`A1+B2+C3→屠龙刀`），仅包含元素ID的关联逻辑，不包含任何参数值。  
  2. 定义表达式的“语法规则”（如：A1必须与B2同时存在，C3需在A1之后生效等）。  
  3. 组合表达式的“标准顺序”遵循**先按卡片标识字母排序，再按选项标识数字排序**（如A1→A9→B1→B2→C3，即字母优先级高于数字，同字母内按数字升序）。  
  4. 表达式存储时自动按标准顺序格式化（如用户输入B2+A1，题库会自动存储为A1+B2）。  
  5. 向反馈区提供“验证标准1”：判断用户提交的元素组合是否符合表达式的元素集合要求（当前不严格验证顺序）。  

### 6.3 环境全量区 → 参数典籍（下半部经书）  
- **核心定位**：独立存储所有元素的“具体参数标准”，不包含组合逻辑，也不直接查询题库（如同“只记载A1=玄铁150kg、B2=淬火工艺、C3=500℃，但不知道这些能组合成屠龙刀”）。  
- **功能**：  
  1. 存储所有元素的参数标准（如A1的`optionValue`标准范围为100-200kg，B2的`selectOptions`必须包含“淬火”，C3的`optionUnit`固定为“℃”）。  
  2. 向反馈区提供“验证标准2”：判断用户提交的元素参数是否符合基础标准（如A1的值是否在100-200kg范围内）。  
  3. 保留原联动同步功能（数据分发、授权管理等），但仅处理“原始信息的传递”，不参与信息的组合逻辑。  

### 6.4 其他模式交互层 → 用户操作终端
- **功能**：  
  1. 接收环境全量区推送的同步数据（参数标准）  
  2. 状态管理将`null`转换为空白（引用3.3节），UI层按3.2.2节规则展示：  
     - 未同步+未授权→ 空白+禁用  
     - 未同步+已授权→ 空白+可编辑  
     - 已同步+未授权→ 同步内容+禁用  
     - 已同步+已授权→ 同步内容+可编辑  
  3. **数据提交原则**：  
     - 提交时以**界面最终显示值**为依据（无论该值是同步而来还是用户编辑输入）  
     - 若为“已同步+未授权”状态（同步内容不可编辑），自动提交界面上显示的同步内容（如同步内容为“500克”，则提交“500克”）  
     - 若为“已同步+已授权”或“未同步+已授权”状态，提交用户最终输入/修改的内容  
     - 若界面显示为空白（包括同步内容为`null`转换的空白、用户未填写的空白），提交时自动转换为`null`（遵循3.3节空值标准）  
  4. 收集用户操作（选择元素及填写参数，如选择A1、B2、C3并输入具体值），按上述原则处理后提交至匹配引擎反馈层  

### 6.5 匹配引擎反馈层 → 经书合璧验证区  
- **核心定位**：唯一能同时调用题库（上半部）和环境全量区（下半部）的模块，通过两道验证实现“经书合璧”，输出最终结果。  
- **功能**：  
  1. **接收输入**：获取其他模式用户填写的完整数据（如用户选择了A1、B2、C3，并填写A1=180kg、B2=淬火、C3=500℃）。  
  2. **第一道验证（题库规则验证）**：  
     - 调用题库的组合表达式（如`A1+B2+C3→屠龙刀`）  
     - 接收用户提交的元素组合（可能无序，如B2+A1+C3），系统自动按“字母+数字”规则排序→ 转换为A1+B2+C3  
     - 验证转换后的元素集合是否与题库表达式完全一致（当前不校验顺序，仅校验元素是否完整匹配）  
     - 若验证失败（如缺少B2），直接返回“组合错误，需包含A1+B2+C3”  
  3. **第二道验证（全量区参数验证）**：  
     - 调用环境全量区的参数标准（如A1标准范围100-200kg、B2必须选“淬火”）  
     - 验证用户填写的具体参数是否符合标准（如A1=180kg在范围内，B2确实选了“淬火”）  
     - 若验证失败（如A1=250kg超出范围），返回“参数错误，A1需在100-200kg之间”  
  4. **输出结果**：两道验证均通过后，输出“匹配成功→屠龙刀”，并展示完整参数（结合用户输入与标准参数）。  


## 7. 环境全量区与联动功能合并说明
### 7.1 合并可行性分析
1. **数据关联性**：  
   环境全量区存储基础配置数据（卡片、选项、参数标准等），联动功能本质是这些数据的跨模式交互工具，两者属于“数据本体”与“交互能力”的强关联关系，合并后逻辑更紧密。

2. **代码结构兼容性**：  
   原实现中，环境配置变更会触发联动区的`notifyEnvConfigChanged`方法，说明两者已存在依赖关系；且联动功能（`syncToMode`、`setFieldAuthorization`等）核心是操作环境配置数据，合并后可减少跨模块调用。

3. **功能合理性**：  
   联动同步作为环境全量区的内置功能，符合“数据管理+交互能力”的一体化设计模式，可简化数据流转链路（减少中间环节），降低维护成本。

4. **职责边界清晰**：  
   环境全量区作为“原始信息仓库”，其核心是存储和分发基础数据；联动功能是“原始信息的跨模式传递工具”，两者均不涉及“信息组合逻辑”（该逻辑由题库专属负责），合并后不会混淆与题库的职责分工。

### 7.2 实施方案
1. **状态结构调整**：  
   将原`linkageSync`合并至`environmentConfigs`，形成统一的环境全量区状态：  
   ```javascript
   environmentConfigs: {
     cards: {},
     options: {},
     uiPresets: [],
     scoringRules: [],
     contextTemplates: [],
     // 原联动区功能整合
     linkage: {
       syncHistory: [],       // 同步历史记录
       fieldAuthorizations: {}, // 字段授权配置
       pendingSyncs: []       // 待同步任务
     }
   }
   ```

2. **功能迁移**：  
   - 将原联动区的同步逻辑（`syncToMode`）、授权管理（`setFieldAuthorization`）迁移至环境全量区的方法集  
   - 保留所有核心逻辑（同步过滤、授权校验、历史记录），仅调整数据引用路径  

3. **模块交互优化**：  
   - 主模式→环境全量区：直接调用`environmentConfigs.syncToMode()`发起同步  
   - 环境全量区→其他模式：同步完成后通过`notifyEnvConfigChanged`直接通知，减少中间转发  
   - 其他模式→环境全量区：通过`environmentConfigs.getFieldAuthorization()`查询授权状态  


## 8. 附录
### 8.1 术语表
| 术语 | 定义 |  
|------|------|  
| 组合ID | 卡片标识+选项标识的组合（如"A1"），用于唯一定位选项 |  
| 正向解析 | 数据模块将UI原始数据（可能不规范）转换为标准化格式（如去空格、补`null`）的过程 |  
| 反向解析 | 状态管理将数据模块的标准化数据转换为UI友好格式（含`null→空白`）的过程 |  
| 同步状态（hasSync） | 控制字段是否在其他模式展示数据的标记（true=展示同步内容，false=无内容） |  
| 授权状态（isAuthorized） | 控制字段是否允许其他模式编辑的标记（true=可编辑，false=只读） |  
| 临时数据 | 用户编辑中未确认保存的数据，需手动操作才持久化 |  
| 环境全量区 | 系统原始信息的全集仓库，存储所有基础元素（卡片、选项、参数等），不包含组合逻辑，仅负责信息的存储与分发。 |  
| 题库 | 组合规则的集合，定义如何将环境全量区的原始信息按特定逻辑组合，形成可直接使用的标准化流程或方案（如生成特定结果的配方）。 |  
| 组合表达式 | 题库中定义的元素关联规则（如`A1+B2+C3→屠龙刀`），其中元素ID（A1等）指向环境全量区的具体选项。 |  
| 原子化元素 | 环境全量区中不可再拆分的基础单元（如单个选项A1及其参数），是所有组合的最小构成单位。 |  
| 第一道验证 | 反馈区对用户提交的元素组合结构进行校验，依据题库的组合表达式判断元素集合是否匹配（当前自动排序后验证，不严格限制顺序）。 |  
| 第二道验证 | 反馈区对用户填写的具体参数进行校验，依据环境全量区的参数标准判断是否符合基础要求（如数值范围、选项合法性）。 |  
| 经书合璧 | 题库（上半部）与环境全量区（下半部）在反馈区通过两道验证实现配合，共同产出完整结果的过程。 |  

### 8.2 组合顺序处理规则  
| 场景 | 当前处理逻辑 | 未来扩展方向 |  
|------|--------------|--------------|  
| 顺序差异 | 自动按“字母+数字”排序后验证（如B2+A1→A1+B2），视为有效组合 | 可配置为“严格顺序验证”（如B2+A1≠A1+B2，视为无效组合） |  
| 排序优先级 | 1. 卡片标识字母（A→Z→AA→AB...）<br>2. 选项标识数字（1→2→...→9→10） | 支持自定义排序规则（如按卡片创建时间、用户自定义优先级） |

-----------------------------------------------------------------------------------------------------

# 项目规范文档（完整最终版）

## 目录
1. 前言
2. Excel样式ID规范
3. 卡片数据结构与状态管理规范
4. 多模式数据处理与流转规范
5. 系统核心架构与分层职责
6. 六大模块数据流程（主线）
7. 附录


## 1. 前言
本文档整合项目全量规范，涵盖标识规则、数据结构、流转逻辑、架构设计及模块职责。核心目标是确保系统各环节遵循统一标准：**数据完整性优先、分层职责清晰、同步授权逻辑明确**，为开发提供唯一权威参考。


## 2. Excel样式ID规范
### 2.1 基础格式定义
采用“卡片标识+选项标识”的组合格式，用于唯一定位卡片及下属选项：
- **卡片标识**：纯大写英文字母序列（A-Z→AA-AZ→BA-BZ...），示例："A"、"BC"、"XYZ"
- **选项标识**：纯阿拉伯数字（1,2,3...），示例："1"、"5"、"12"
- **完整ID**：卡片标识+选项标识，示例："A1"（A卡片第1个选项）、"BC3"（BC卡片第3个选项）

### 2.2 生成规则
#### 2.2.1 卡片标识生成
- 初始标识为"A"，按字母顺序递增，单字母用尽后自动扩展位数：
  - 单字母：A→B→...→Z（共26个）
  - 双字母：AA→AB→...→AZ→BA→...→BZ（共26×26个）
  - 以此类推（三字母、四字母等）
- 生成函数示例：
  ```javascript
  function generateNextCardId(lastId) {
    let chars = lastId.split('');
    let i = chars.length - 1;
    while (i >= 0 && chars[i] === 'Z') {
      chars[i] = 'A';
      i--;
    }
    if (i < 0) chars.unshift('A');
    else chars[i] = String.fromCharCode(chars[i].charCodeAt(0) + 1);
    return chars.join('');
  }
  ```

#### 2.2.2 选项标识生成
- 每个卡片的首个选项标识为"1"
- 新增选项时，标识为当前卡片已有选项中的**最大标识+1**（与删除无关）：
  - 示例1：现有选项["1","2","3"]→新增为"4"
  - 示例2：现有选项["1","3","5"]→新增为"6"（最大标识为5，5+1=6）
- 生成函数示例：
  ```javascript
  function generateNextOptionId(existingOptions) {
    const maxId = existingOptions.reduce((max, id) => {
      const num = parseInt(id, 10);
      return num > max ? num : max;
    }, 0);
    return (maxId + 1).toString();
  }
  ```

### 2.3 解析规则
- 解析目标：将完整ID拆分为卡片标识和选项标识
- 解析函数示例：
  ```javascript
  function parseCombinedId(combinedId) {
    const match = combinedId.match(/^([A-Z]+)(\d+)$/);
    if (!match) return { isValid: false };
    return {
      combinedId,
      cardId: match[1],
      optionId: match[2],
      isValid: true
    };
  }
  ```
- 无效格式示例："a1"（小写字母）、"1A"（数字在前）、"A-1"（含特殊字符）


## 3. 卡片数据结构与状态管理规范
### 3.1 核心数据结构（五项内容规范）
卡片及选项的基础结构必须包含以下字段，**无论是否有值/是否同步，字段均需存在**：

| 字段标识         | 含义                  | 数据类型                  | 空值标准（数据层） | 说明 |
|------------------|-----------------------|---------------------------|--------------------|------|
| `title`          | 卡片标题              | string \| null            | `null`             | 卡片的整体名称 |
| `optionName`     | 选项名称              | string \| null            | `null`             | 单个选项的名称 |
| `optionValue`    | 选项值                | string \| number \| null  | `null`             | 选项的具体数值或文本 |
| `optionUnit`     | 选项单位              | string \| null            | `null`             | 选项值的单位（如"kg"、"个"） |
| `selectOptions`  | 下拉菜单选项          | string[]                  | `[]`（空数组）     | 预定义的可选值列表 |

### 3.2 同步与授权状态（syncStatus）
同步控制“是否有数据可展示”，授权控制“是否允许编辑”，两者独立且需显式配置：

#### 3.2.1 状态结构interface SyncStatus {
  title: { 
    hasSync: boolean; // 是否同步数据（true=有数据可展示，false=无数据）
    isAuthorized: boolean; // 是否允许编辑（true=可编辑，false=只读）
  };
  options: {
    name: { hasSync: boolean; isAuthorized: boolean };
    value: { hasSync: boolean; isAuthorized: boolean };
    unit: { hasSync: boolean; isAuthorized: boolean };
  };
  selectOptions: { 
    hasSync: true; // 固定为true（结构必须同步）
    isAuthorized: false; // 固定为false（仅主模式可编辑）
  };
}
#### 3.2.2 其他模式表现（核心逻辑）
| 场景 | 同步状态（hasSync） | 授权状态（isAuthorized） | 其他模式UI表现 |
|------|---------------------|--------------------------|----------------|
| 1    | false（未同步）     | false（未授权）          | 显示空白，控件禁用（不可编辑） |
| 2    | false（未同步）     | true（已授权）           | 显示空白，控件可交互（允许输入） |
| 3    | true（已同步）      | false（未授权）          | 显示同步的内容，控件禁用（灰色） |
| 4    | true（已同步）      | true（已授权）           | 显示同步的内容（作为提示），控件可交互（允许修改） |

### 3.3 空值处理（分层职责）
空值处理严格遵循分层原则，**禁止UI层参与数据转换**：

| 层级         | 处理逻辑                                                                 | 示例                          |
|--------------|--------------------------------------------------------------------------|-------------------------------|
| **数据层**   | 所有空值必须显式存储为`null`（禁止使用空字符串`""`、`undefined`或缺失字段） | 未填写的标题存储为`title: null` |
| **状态管理** | 负责反向解析：将数据层的`null`转换为UI层可直接使用的空白（`""`）           | 转换函数：`storageToDisplay = (v) => v === null ? "" : String(v)` |
| **UI层**     | 直接使用状态管理传递的已转换数据（空白），不处理任何值转换逻辑              | 输入框绑定状态管理的`displayValue`（空白则显示空输入框） |


## 4. 多模式数据处理与流转规范
### 4.1 核心流转规则（跨模块通用）
- **同步触发**：仅支持主模式手动点击同步按钮（无自动同步）
- **数据过滤**：按`syncStatus.hasSync`筛选字段（未同步字段在目标模式中为`null`）
- **失败处理**：同步失败仅支持手动重试（无自动重试）
- **空值传递**：流转过程中保持`null`不变，由状态管理在各模块内转换为空白（引用3.3节）

### 4.2 临时数据与持久化规则
- **临时数据（_tempData）**：  
  - 定义：用户正在编辑但未确认保存的数据（如未点击“保存”按钮的草稿）  
  - 存储：仅存在于内存，关闭页面或刷新后丢失  
  - 转换：需手动点击“添加到题库”按钮（`persistToLibrary()`）才转为持久化数据  

- **持久化数据（_persistedData）**：  
  - 存储位置：题库及环境全量信息区  
  - 存储范围：手动添加时，**自动存储全量信息**（包括未勾选同步的字段、未编辑的空值字段）  
  - 关联存储：添加到题库时，自动同步更新环境全量信息区的关联配置  


## 5. 系统核心架构与分层职责
### 5.1 分层架构
| 层级         | 技术实现          | 核心职责                                                                 | 禁止行为                                                                 |
|--------------|-------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| **UI层**     | Vue组件（.vue）   | 1. 渲染页面元素（按钮、输入框等）<br>2. 接收用户操作并调用状态管理方法<br>3. 展示状态管理提供的已转换数据（空白/同步内容） | 1. 禁止直接访问数据模块<br>2. 不处理任何数据转换（如`null→空白`）<br>3. 不存储数据（所有数据从状态管理获取） |
| **状态管理** | Vue Pinia         | 1. 作为中间层，转发UI层指令到数据模块<br>2. 执行反向解析（含`null→空白`转换）<br>3. 维护响应式状态供UI层使用 | 1. 不存储原始数据（从数据模块获取，不缓存副本）<br>2. 不参与正向解析（不处理UI原始数据的标准化） |
| **数据模块** | JavaScript模块    | 1. 存储全量数据（临时+持久化）<br>2. 执行正向解析（UI原始数据→标准化格式）<br>3. 提供数据操作接口（仅对状态管理开放） | 1. 不处理UI交互逻辑<br>2. 不参与反向解析（不关心UI展示格式）<br>3. 不直接暴露内部数据（返回副本） |

### 5.2 单模块内部数据处理（技术细节）
以“用户在其他模式编辑选项值”为例，描述单个模块内的分层交互：  
1. **用户输入**：UI层接收原始输入（如" 5 "，带空格）→ 调用状态管理`updateOptionValue(rawData)`  
2. **指令转发**：状态管理将原始数据转发给数据模块`updateTempData(rawData)`  
3. **正向解析**：数据模块标准化处理（去空格→"5"，若为空则存`null`）→ 更新临时数据  
4. **反向解析**：状态管理从数据模块获取标准化数据→ 转换为UI格式（"5"或空白）  
5. **UI展示**：UI层从状态管理获取已转换数据，更新输入框显示  


## 6. 六大模块数据流程（主线）
按数据从源头到结尾的顺序描述，明确模块间的衔接关系：

### 6.1 主模式（root_admin）→ 数据源头
- **功能**：  
  1. 按ExcelID规则创建卡片/选项（引用2.2节）  
  2. 配置卡片数据（`title`/`optionValue`等，引用3.1节）  
  3. 设定`syncStatus`（同步/授权规则，引用3.2节）  
  4. 手动触发两个关键操作：  
     - 点击“保存到题库”→ 将临时数据持久化到题库（引用4.2节）  
     - 点击“同步到其他模式”→ 将数据推送至联动同步授权推送区  

### 6.2 题库 → 数据存储中心
- **功能**：  
  1. 接收主模式的持久化数据（全量存储，包括未同步字段）  
  2. 存储配方规则及选项依赖关系  
  3. 向环境全量信息区同步数据（自动关联存储）  

### 6.3 环境全量信息区 → 数据分发枢纽
- **功能**：  
  1. 接收题库的全量数据，作为系统统一信息源  
  2. 为所有模块提供数据查询接口（如主模式查询历史配置、其他模式查询基础结构）  

### 6.4 联动同步授权推送区 → 数据中转站
- **功能**：  
  1. 接收主模式的同步指令及数据  
  2. 按`syncStatus`过滤数据（未同步字段设为`null`，引用4.1节）  
  3. 将过滤后的数据推送至目标“其他模式”  

### 6.5 其他模式交互层 → 用户操作终端
- **功能**：  
  1. 接收联动同步授权推送区的同步数据  
  2. 状态管理将`null`转换为空白（引用3.3节），UI层按3.2.2节规则展示：  
     - 未同步+未授权→ 空白+禁用  
     - 未同步+已授权→ 空白+可编辑  
     - 已同步+未授权→ 同步内容+禁用  
     - 已同步+已授权→ 同步内容+可编辑  
  3. 收集用户操作（选择/输入），提交至匹配引擎  

### 6.6 匹配引擎反馈层 → 结果输出终端
- **功能**：  
  1. 接收其他模式提交的用户操作数据  
  2. 与题库中的配方规则进行匹配（粗糙保留基础逻辑）  
  3. 向其他模式返回匹配结果，由UI层展示  


## 7. 附录
### 7.1 术语表
| 术语 | 定义 |
|------|------|
| 组合ID | 卡片标识+选项标识的组合（如"A1"），用于唯一定位选项 |
| 正向解析 | 数据模块将UI原始数据（可能不规范）转换为标准化格式（如去空格、补`null`）的过程 |
| 反向解析 | 状态管理将数据模块的标准化数据转换为UI友好格式（含`null→空白`）的过程 |
| 同步状态（hasSync） | 控制字段是否在其他模式展示数据的标记（true=展示同步内容，false=无内容） |
| 授权状态（isAuthorized） | 控制字段是否允许其他模式编辑的标记（true=可编辑，false=只读） |
| 临时数据 | 用户编辑中未确认保存的数据，需手动操作才持久化 |